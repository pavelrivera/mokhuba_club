{# templates/dashboard/membership-selection.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Seleccionar Membresía - Mokhuba Club{% endblock %}

{% block body_class %}membership-selection{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    /* =====================================================
       MEMBERSHIP SELECTION STYLES
    ===================================================== */
    .membership-selection-layout {
        min-height: 100vh;
        background: linear-gradient(135deg, var(--deep-brown) 0%, var(--dark-brown) 50%, #2a1a19 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .membership-container {
        max-width: 1200px;
        width: 100%;
    }

    .header-section {
        text-align: center;
        margin-bottom: 48px;
    }

    .main-title {
        font-size: 3rem;
        color: var(--cream);
        margin-bottom: 16px;
        font-family: var(--font-heading);
        font-weight: 700;
    }

    .main-subtitle {
        font-size: 1.25rem;
        color: rgba(255, 248, 220, 0.8);
        margin-bottom: 8px;
    }

    .main-description {
        color: rgba(255, 248, 220, 0.6);
        font-size: 1rem;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
    }

    .user-welcome {
        background: rgba(45, 24, 23, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 48px;
        text-align: center;
    }

    .welcome-message {
        color: var(--gold-primary);
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .welcome-instruction {
        color: rgba(255, 248, 220, 0.8);
        font-size: 0.95rem;
    }

    .memberships-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 32px;
        margin-bottom: 48px;
    }

    .membership-card {
        background: rgba(45, 24, 23, 0.8);
        backdrop-filter: blur(10px);
        border: 2px solid transparent;
        border-radius: 20px;
        padding: 32px 24px;
        text-align: center;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .membership-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--card-gradient, linear-gradient(135deg, #e74c3c, #c0392b));
    }

    .membership-card:hover {
        transform: translateY(-8px);
        border-color: var(--card-color, #e74c3c);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 32px var(--card-shadow, rgba(231, 76, 60, 0.3));
    }

    /* Ruby Card */
    .membership-card.ruby {
        --card-color: #e74c3c;
        --card-gradient: linear-gradient(135deg, #e74c3c, #c0392b);
        --card-shadow: rgba(231, 76, 60, 0.3);
    }

    /* Gold Card */
    .membership-card.gold {
        --card-color: #f39c12;
        --card-gradient: linear-gradient(135deg, #f39c12, #e67e22);
        --card-shadow: rgba(243, 156, 18, 0.3);
    }

    /* Platinum Card */
    .membership-card.platinum {
        --card-color: #95a5a6;
        --card-gradient: linear-gradient(135deg, #95a5a6, #7f8c8d);
        --card-shadow: rgba(149, 165, 166, 0.3);
    }

    .membership-card.popular {
        border-color: var(--card-color);
        transform: scale(1.05);
    }

    .membership-card.popular::after {
        content: 'MÁS POPULAR';
        position: absolute;
        top: 20px;
        right: -30px;
        background: var(--card-gradient);
        color: white;
        padding: 4px 40px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 1px;
        transform: rotate(45deg);
    }

    .membership-icon {
        width: 80px;
        height: 80px;
        background: var(--card-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        margin: 0 auto 24px;
        box-shadow: 0 8px 24px var(--card-shadow);
    }

    .membership-name {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--cream);
        margin-bottom: 8px;
        font-family: var(--font-heading);
    }

    .membership-price {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--card-color);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .price-currency {
        font-size: 1.5rem;
    }

    .price-period {
        font-size: 0.9rem;
        color: rgba(255, 248, 220, 0.6);
        margin-bottom: 24px;
    }

    .membership-features {
        list-style: none;
        padding: 0;
        margin: 0 0 32px 0;
    }

    .membership-features li {
        padding: 8px 0;
        color: rgba(255, 248, 220, 0.8);
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .membership-features li::before {
        content: '✓';
        color: var(--card-color);
        font-weight: bold;
        font-size: 1.1rem;
    }

    .select-btn {
        background: var(--card-gradient);
        color: white;
        padding: 14px 32px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .select-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px var(--card-shadow);
    }

    .select-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .select-btn.processing {
        position: relative;
        color: transparent;
    }

    .select-btn.processing::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 3px solid #ffffff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .contact-section {
        text-align: center;
        background: rgba(45, 24, 23, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 16px;
        padding: 32px;
    }

    .contact-title {
        color: var(--gold-primary);
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 12px;
    }

    .contact-description {
        color: rgba(255, 248, 220, 0.8);
        margin-bottom: 24px;
        line-height: 1.6;
    }

    .contact-btn {
        background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
        color: var(--dark-brown);
        padding: 14px 32px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .contact-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
    }

    .logout-link {
        position: fixed;
        top: 20px;
        right: 20px;
        background: transparent;
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: var(--error);
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
    }

    .logout-link:hover {
        background: var(--error);
        color: white;
        border-color: var(--error);
    }

    /* =====================================================
       RESPONSIVE
    ===================================================== */
    @media (max-width: 768px) {
        .membership-selection-layout {
            padding: 10px;
        }

        .main-title {
            font-size: 2.2rem;
        }

        .main-subtitle {
            font-size: 1.1rem;
        }

        .memberships-grid {
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .membership-card.popular {
            transform: none;
        }

        .membership-card:hover {
            transform: translateY(-4px);
        }

        .logout-link {
            position: relative;
            top: auto;
            right: auto;
            margin: 20px auto;
            width: fit-content;
            display: flex;
        }
    }

    @media (max-width: 480px) {
        .main-title {
            font-size: 1.8rem;
        }

        .membership-card {
            padding: 24px 16px;
        }

        .membership-icon {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .membership-name {
            font-size: 1.5rem;
        }

        .membership-price {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="membership-selection-layout">
    <div class="membership-container">
        <!-- Header Section -->
        <div class="header-section">
            <h1 class="main-title">Mokhuba Cigar Club</h1>
            <h2 class="main-subtitle">Selecciona tu nivel de membresía</h2>
            <p class="main-description">
                Únete a la experiencia más exclusiva del mundo del tabaco premium. 
                Cada nivel de membresía está diseñado para ofrecerte beneficios únicos y experiencias inolvidables.
            </p>
        </div>

        <!-- User Welcome -->
        {% if app.user %}
        <div class="user-welcome">
            <div class="welcome-message">¡Hola, {{ app.user.firstName }} {{ app.user.lastName }}!</div>
            <div class="welcome-instruction">Para acceder a tu dashboard, selecciona el nivel de membresía que deseas.</div>
        </div>
        {% endif %}

        <!-- Memberships Grid -->
        <div class="memberships-grid">
            <!-- Ruby Membership -->
            <div class="membership-card ruby" onclick="selectMembership('ruby')">
                <div class="membership-icon">
                    <i class="fas fa-gem"></i>
                </div>
                <h3 class="membership-name">Rubí</h3>
                <div class="membership-price">
                    <span class="price-currency">$</span>299
                </div>
                <div class="price-period">por año</div>
                <ul class="membership-features">
                    <li>Acceso a eventos mensuales</li>
                    <li>Compras exclusivas</li>
                    <li>Regalo de cumpleaños</li>
                    <li>Nuevas vitolas prioritarias</li>
                </ul>
                <button class="select-btn" id="btn-ruby">Seleccionar Rubí</button>
            </div>

            <!-- Gold Membership -->
            <div class="membership-card gold popular" onclick="selectMembership('gold')">
                <div class="membership-icon">
                    <i class="fas fa-medal"></i>
                </div>
                <h3 class="membership-name">Oro</h3>
                <div class="membership-price">
                    <span class="price-currency">$</span>599
                </div>
                <div class="price-period">por año</div>
                <ul class="membership-features">
                    <li>Todo lo de Rubí</li>
                    <li>1 marca personalizada</li>
                    <li>Hasta 2 líneas por marca</li>
                    <li>1 regalo adicional/año</li>
                </ul>
                <button class="select-btn" id="btn-gold">Seleccionar Oro</button>
            </div>

            <!-- Platinum Membership -->
            <div class="membership-card platinum" onclick="selectMembership('platinum')">
                <div class="membership-icon">
                    <i class="fas fa-star"></i>
                </div>
                <h3 class="membership-name">Platino</h3>
                <div class="membership-price">
                    <span class="price-currency">$</span>999
                </div>
                <div class="price-period">por año</div>
                <ul class="membership-features">
                    <li>Todo lo de Oro</li>
                    <li>Hasta 3 marcas premium</li>
                    <li>Hasta 6 líneas por marca</li>
                    <li>2 acompañantes a eventos</li>
                    <li>Regalo de aniversario</li>
                    <li>Concierge 24/7</li>
                </ul>
                <button class="select-btn" id="btn-platinum">Seleccionar Platino</button>
            </div>
        </div>

        <!-- Contact Section -->
        <div class="contact-section">
            <h3 class="contact-title">¿Necesitas ayuda para decidir?</h3>
            <p class="contact-description">
                Nuestro equipo de expertos está disponible para ayudarte a elegir la membresía 
                que mejor se adapte a tus preferencias y estilo de vida.
            </p>
            <a href="mailto:info@mokhubaclub.com" class="contact-btn">
                <i class="fas fa-envelope"></i>
                Contactar Asesor
            </a>
        </div>
    </div>

    <!-- Logout Link -->
    {% if app.user %}
    <a href="{{ path('auth_logout') }}" class="logout-link">
        <i class="fas fa-sign-out-alt"></i>
        Cerrar Sesión
    </a>
    {% endif %}
</div>

<script>
/**
 * =====================================================
 * JAVASCRIPT CORREGIDO - NO USA alert()
 * =====================================================
 * Este código crea y envía un formulario directamente
 * sin usar alert() para evitar el modal "En desarrollo"
 */
function selectMembership(level) {
    console.log('Membresía seleccionada:', level);
    
    const levelNames = {
        'ruby': 'Rubí',
        'gold': 'Oro',
        'platinum': 'Platino'
    };
    
    // Confirmación usando confirm (NO alert)
    const confirmed = confirm('¿Confirmas que deseas la membresía ' + levelNames[level] + '?\n\nSerás redirigido al sistema de pago.');
    
    if (confirmed) {
        // Deshabilitar todos los botones
        disableAllButtons();
        
        // Añadir clase de procesamiento
        const button = document.getElementById('btn-' + level);
        if (button) {
            button.classList.add('processing');
        }
        
        // Crear y enviar formulario INMEDIATAMENTE
        createAndSubmitForm(level);
    }
}

/**
 * Deshabilitar todos los botones
 */
function disableAllButtons() {
    const buttons = document.querySelectorAll('.select-btn');
    buttons.forEach(function(btn) {
        btn.disabled = true;
    });
}

/**
 * Habilitar todos los botones
 */
function enableAllButtons() {
    const buttons = document.querySelectorAll('.select-btn');
    buttons.forEach(function(btn) {
        btn.disabled = false;
        btn.classList.remove('processing');
    });
}

/**
 * Crear y enviar formulario al servidor
 * ESTA ES LA FUNCIÓN CRÍTICA - NO TOCA
 */
function createAndSubmitForm(level) {
    try {
        console.log('Creando formulario para:', level);
        
        // Crear formulario
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ path("payment_create_checkout") }}';
        
        // Crear input hidden
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'membershipType';
        input.value = level;
        
        // Añadir input al formulario
        form.appendChild(input);
        
        // Añadir formulario al body
        document.body.appendChild(form);
        
        console.log('Enviando formulario...', {
            action: form.action,
            method: form.method,
            membershipType: level
        });
        
        // Enviar formulario
        form.submit();
        
    } catch (error) {
        console.error('Error creando formulario:', error);
        enableAllButtons();
        // Aquí SÍ podemos usar alert porque es un error real
        window.nativeAlert = window.nativeAlert || alert;
        window.nativeAlert('Error al procesar la solicitud. Por favor, intenta de nuevo.');
    }
}

/**
 * Animación de entrada
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página cargada. Sistema de pagos listo.');
    
    const cards = document.querySelectorAll('.membership-card');
    cards.forEach(function(card, index) {
        setTimeout(function() {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            card.style.transition = 'all 0.6s ease';
            
            setTimeout(function() {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }, index * 200);
    });
});
</script>

{% include 'partials/logout_and_confirm.html.twig' %}
{% endblock %}
